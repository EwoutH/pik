// Copyright 2017 Google Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include "quantizer.h"

#include <stdio.h>
#include <algorithm>
#include <sstream>
#include <vector>

#define PROFILER_ENABLED 1
#include "arch_specific.h"
#include "cache_aligned.h"
#include "common.h"
#include "compiler_specific.h"
#include "dct.h"
#include "entropy_coder.h"
#include "profiler.h"
#include "simd/simd.h"

namespace pik {

static const int kDefaultQuant = 64;

// kQuantWeights[3 * k_zz + c] is the relative weight of the k_zz coefficient
// (in the zig-zag order) in component c. Higher weights correspond to finer
// quantization intervals and more bits spent in encoding.
template <int N>
const double* GetQuantWeights();

// clang-format off
template <>
const double* GetQuantWeights<8>() {
  static double kQuantWeights[kNumQuantTables * kNumQuantKinds * 3 * 8 * 8] = {
    // Default weights.
    8.007739682555457, 0.790464926850624, 0.896757098257276,
    7.007739682555457, 1.690464926850624, 0.266757098257276,
    7.007739682555457, 1.690464926850624, 0.266757098257276,
    4.107739682555457, 1.190464926850624, 0.266757098257276,
    2.718641132515788, 0.949011936383757, 0.152511645097545,
    2.572816731339207, 0.588994181958768, 0.118100765334953,
    2.032215873775081, 0.637412731903807, 0.095345784097884,
    2.315870235563686, 0.658265403732354, 0.110371519145527,

    2.012821062900509, 0.664184545211087, 0.099475746290082,
    1.449397258122384, 0.489557940162741, 0.067786287339414,
    1.436975929855242, 0.441809196703547, 0.094536040820037,
    1.865878925739592, 0.466519636930879, 0.124177967522903,
    2.008461025719845, 0.508335971631046, 0.084353699119085,
    1.655661941311688, 0.501624976604618, 0.085987364421881,
    1.130603813427013, 0.447903166596090, 0.067923441158408,
    1.022532430225431, 0.487108568611555, 0.080881061091476,

    1.272156074269336, 0.457498177649116, 0.082459662895532,
    1.447104381579635, 0.452848682971061, 0.078190967783448,
    1.584199478317816, 0.490734792977206, 0.100346135292203,
    1.635779039524479, 0.443057415317534, 0.100009332174115,
    1.113399845075454, 0.392141167751584, 0.092199290737570,
    1.064999034721906, 0.358316869050728, 0.086204871775776,
    1.279053398805468, 0.418207067977596, 0.083260412562490,
    1.747611513297777, 0.467858769794496, 0.069949912716638,

    1.663208511656283, 0.443549876397044, 0.072702114499231,
    1.829429432077740, 0.427476997048851, 0.082222173794410,
    1.195057810739710, 0.356915568577037, 0.070777508484918,
    0.729670388571311, 0.303161982522844, 0.050483254923282,
    0.728116090277295, 0.363256217129902, 0.039258052812753,
    0.828160200598777, 0.352611929358839, 0.038883521020087,
    1.812202920392621, 0.418999909922867, 0.077842102104594,
    1.330600793950037, 0.398691116916629, 0.051870762283444,

    1.887045211954473, 0.377526872102006, 0.047237629663560,
    0.755528683401189, 0.352326109479318, 0.041806493756569,
    0.793129106155553, 0.308206968728254, 0.081986859100514,
    0.582115570560486, 0.280093699425257, 0.050543873900035,
    0.694544165211246, 0.304147527622546, 0.047381945801451,
    0.939876178932170, 0.359202623799680, 0.081638086097729,
    1.161927662049290, 0.339645164723791, 0.062157667954369,
    0.884831292420533, 0.349585237941005, 0.073892958779233,

    1.579952097805803, 0.386203903613304, 0.087990979657756,
    1.044005235902287, 0.353582036654603, 0.080634548618387,
    1.179117253059526, 0.305955548639682, 0.060926229893166,
    1.628189876466003, 0.365259530060446, 0.060404953045889,
    0.924835280526811, 0.333159510814334, 0.098008271707150,
    1.104745203202202, 0.363133568767434, 0.072924218127585,
    0.813967217002860, 0.334161790012618, 0.044418130775328,
    1.471875266985009, 0.389194124900511, 0.085864972300856,

    0.862510713318923, 0.349326306148990, 0.063143197598232,
    0.999224479322217, 0.390310895605386, 0.058943077673598,
    1.093342865822922, 0.408666924454222, 0.056598722882749,
    1.165854968276223, 0.335930464190049, 0.049689442794662,
    1.207998947979852, 0.359313000261458, 0.070898673597830,
    1.585093375601523, 0.381109877480420, 0.050224170839591,
    0.706140666001836, 0.392933763109596, 0.061093567734882,
    1.324578110665745, 0.359529015172913, 0.070017243293272,

    0.490812708625390, 0.347676628893596, 0.049689543258151,
    0.926889395128129, 0.370974565818013, 0.073810062982239,
    0.585976820275277, 0.350361463992334, 0.075501917961477,
    0.985343394140973, 0.338064798002449, 0.061863427753985,
    1.189800190860163, 0.336743523710490, 0.067574852233388,
    0.863094923618105, 0.296631529585931, 0.077231104320266,
    0.928059682508765, 0.304517245589665, 0.068924420696647,
    0.934658688963937, 0.302956514467806, 0.061324055115453,

    // ID weights. TODO(user): consider changing.
    8.007739682555457, 0.790464926850624, 0.896757098257276,
    7.007739682555457, 1.690464926850624, 0.266757098257276,
    7.007739682555457, 1.690464926850624, 0.266757098257276,
    4.107739682555457, 1.190464926850624, 0.266757098257276,
    2.718641132515788, 0.949011936383757, 0.152511645097545,
    2.572816731339207, 0.588994181958768, 0.118100765334953,
    2.032215873775081, 0.637412731903807, 0.095345784097884,
    2.315870235563686, 0.658265403732354, 0.110371519145527,

    2.012821062900509, 0.664184545211087, 0.099475746290082,
    1.449397258122384, 0.489557940162741, 0.067786287339414,
    1.436975929855242, 0.441809196703547, 0.094536040820037,
    1.865878925739592, 0.466519636930879, 0.124177967522903,
    2.008461025719845, 0.508335971631046, 0.084353699119085,
    1.655661941311688, 0.501624976604618, 0.085987364421881,
    1.130603813427013, 0.447903166596090, 0.067923441158408,
    1.022532430225431, 0.487108568611555, 0.080881061091476,

    1.272156074269336, 0.457498177649116, 0.082459662895532,
    1.447104381579635, 0.452848682971061, 0.078190967783448,
    1.584199478317816, 0.490734792977206, 0.100346135292203,
    1.635779039524479, 0.443057415317534, 0.100009332174115,
    1.113399845075454, 0.392141167751584, 0.092199290737570,
    1.064999034721906, 0.358316869050728, 0.086204871775776,
    1.279053398805468, 0.418207067977596, 0.083260412562490,
    1.747611513297777, 0.467858769794496, 0.069949912716638,

    1.663208511656283, 0.443549876397044, 0.072702114499231,
    1.829429432077740, 0.427476997048851, 0.082222173794410,
    1.195057810739710, 0.356915568577037, 0.070777508484918,
    0.729670388571311, 0.303161982522844, 0.050483254923282,
    0.728116090277295, 0.363256217129902, 0.039258052812753,
    0.828160200598777, 0.352611929358839, 0.038883521020087,
    1.812202920392621, 0.418999909922867, 0.077842102104594,
    1.330600793950037, 0.398691116916629, 0.051870762283444,

    1.887045211954473, 0.377526872102006, 0.047237629663560,
    0.755528683401189, 0.352326109479318, 0.041806493756569,
    0.793129106155553, 0.308206968728254, 0.081986859100514,
    0.582115570560486, 0.280093699425257, 0.050543873900035,
    0.694544165211246, 0.304147527622546, 0.047381945801451,
    0.939876178932170, 0.359202623799680, 0.081638086097729,
    1.161927662049290, 0.339645164723791, 0.062157667954369,
    0.884831292420533, 0.349585237941005, 0.073892958779233,

    1.579952097805803, 0.386203903613304, 0.087990979657756,
    1.044005235902287, 0.353582036654603, 0.080634548618387,
    1.179117253059526, 0.305955548639682, 0.060926229893166,
    1.628189876466003, 0.365259530060446, 0.060404953045889,
    0.924835280526811, 0.333159510814334, 0.098008271707150,
    1.104745203202202, 0.363133568767434, 0.072924218127585,
    0.813967217002860, 0.334161790012618, 0.044418130775328,
    1.471875266985009, 0.389194124900511, 0.085864972300856,

    0.862510713318923, 0.349326306148990, 0.063143197598232,
    0.999224479322217, 0.390310895605386, 0.058943077673598,
    1.093342865822922, 0.408666924454222, 0.056598722882749,
    1.165854968276223, 0.335930464190049, 0.049689442794662,
    1.207998947979852, 0.359313000261458, 0.070898673597830,
    1.585093375601523, 0.381109877480420, 0.050224170839591,
    0.706140666001836, 0.392933763109596, 0.061093567734882,
    1.324578110665745, 0.359529015172913, 0.070017243293272,

    0.490812708625390, 0.347676628893596, 0.049689543258151,
    0.926889395128129, 0.370974565818013, 0.073810062982239,
    0.585976820275277, 0.350361463992334, 0.075501917961477,
    0.985343394140973, 0.338064798002449, 0.061863427753985,
    1.189800190860163, 0.336743523710490, 0.067574852233388,
    0.863094923618105, 0.296631529585931, 0.077231104320266,
    0.928059682508765, 0.304517245589665, 0.068924420696647,
    0.934658688963937, 0.302956514467806, 0.061324055115453,

    // DCT16 NW weights. TODO(user): consider changing.
    26.06719879633798, 4.0387064099792651, 2.1623717910577174,
    31.130733406213661, 5.2368122477879862, 1.8444933410288054,
    2.4565037636739424, 1.4218074216659637, 0.32440648521193183,
    21.894438929276767, 4.3474569623669215, 1.0783416739608753,
    1.5551890706740705, 1.4492722286198778, 0.75069787472813865,
    12.849323313012532, 4.6089035998402137, 0.51969685875479166,
    8.3663917926666471, 4.0230712065773879, 0.017000000000000001,
    5.1708644121735983, 0.86856239183277018, 0.017000000000000001,

    24.572287839802755, 10.004123659966215, 1.4398360879092009,
    0.017000000000000001, 0.66489159652344587, 0.33489113178685165,
    6.7983731736234851, 2.9494720257450995, 0.29402865152628965,
    0.017000000000000001, 0.81427646996460001, 0.017000000000000001,
    15.555900702789833, 7.3360530339437489, 0.53250520462868445,
    4.1201389054614754, 0.67057920077173117, 0.017000000000000001,
    3.9202666995260005, 2.7464523834046473, 0.017000000000000001,
    3.0867265830449484, 1.76018478713532, 0.017000000000000001,

    2.1026571992297551, 0.41616714550562672, 0.017000000000000001,
    13.867090671121712, 7.250083052447267, 0.017000000000000001,
    1.767805858739351, 0.97366923308965747, 0.017000000000000001,
    0.017000000000000001, 6.6465292310574631, 0.54157892349623216,
    3.4342011599446201, 0.57549522027517641, 0.017000000000000001,
    3.3206714779458864, 1.7336219450883659, 0.16328746726481752,
    0.017000000000000001, 0.6511435583175571, 0.017000000000000001,
    2.5203667290314606, 6.1713845779394783, 0.017000000000000001,

    3.4573973346151794, 0.6334509612868775, 0.017000000000000001,
    0.017000000000000001, 4.7970803444684593, 0.19064392419692455,
    0.017000000000000001, 0.20192678854895851, 0.017000000000000001,
    1.6591407867280399, 0.6600532071382027, 0.017000000000000001,
    0.017000000000000001, 0.296252848689953, 0.017000000000000001,
    0.017000000000000001, 0.075701674823026421, 0.017000000000000001,
    4.9139788833562887, 2.5679211370868096, 0.017000000000000001,
    3.1050450202982374, 0.4038548142373401, 0.017000000000000001,

    1.9779869071224212, 4.9406610362811829, 0.017000000000000001,
    3.840689581185643, 0.54607821960380021, 0.017000000000000001,
    4.597554316381709, 3.146449589731465, 0.017000000000000001,
    0.017000000000000001, 0.26616602000146639, 0.017000000000000001,
    0.57180565281077356, 0.31068681635736128, 0.017000000000000001,
    6.6541763203875073, 2.4585882186843926, 0.017000000000000001,
    1.3217566732158306, 0.36773069575733686, 0.017000000000000001,
    0.017000000000000001, 3.3486861165818276, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    2.325011583445427, 1.507076333486381, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.0762365336215649, 0.53022407744602196, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    3.9471551399682974, 1.8703124042707322, 0.12688851698738224,
    2.6123838156182231, 0.26935882104067743, 0.017000000000000001,
    4.917171559491937, 1.9191611714711172, 0.017000000000000001,

    0.53650375747435408, 0.21363792118137639, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    2.3437849543427829, 1.4087186544833237, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.9023098698864658, 0.89708865266017979, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.2244449671456585, 0.32122103633328492, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    2.5400187477003211, 0.75877612914605286, 0.017000000000000001,
    0.62254723430462111, 0.10360906724694241, 0.017000000000000001,
    0.017000000000000001, 0.057307720250286465, 0.017000000000000001,
    1.8009637205990887, 0.40452444764107454, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.18724577676289106, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    // DCT16 NE weights. TODO(user): consider changing.
    5.4668743209296853, 3.7148003801074978, 0.017000000000000001,
    6.8064443106584154, 5.2899392076041911, 0.76197768788191544,
    0.47982300035784764, 1.5528246097340097, 0.52722724722132752,
    4.4026266318547229, 3.0020290105471377, 0.520041296551914,
    0.20900135817892851, 1.7676352067507326, 0.68839384379552748,
    0.017000000000000001, 4.64125790734633, 0.62424641037501571,
    6.7769961275966519, 3.3613275546907126, 0.017000000000000001,
    0.81572662768796844, 1.4022596740083269, 0.017000000000000001,

    0.83075345403066203, 4.3673603818650841, 0.29134895891314583,
    0.017000000000000001, 0.74765676831370431, 0.017000000000000001,
    0.017000000000000001, 0.96236088406634024, 0.20342909015223262,
    3.1552057366374395, 0.83650932677682832, 0.017000000000000001,
    1.0571098969421082, 4.4183462842100214, 1.1728809248810952,
    3.8948764148909212, 0.92928546874748075, 0.017000000000000001,
    0.017000000000000001, 2.9816424794129124, 0.017000000000000001,
    3.628648297700261, 1.3944750812876023, 0.017000000000000001,

    3.5014210975076594, 0.57121809700386161, 0.017000000000000001,
    6.6290784667202551, 3.0079357867423897, 0.017000000000000001,
    0.4414704285152955, 0.83073029776078522, 0.017000000000000001,
    0.017000000000000001, 2.541790472079609, 0.61360676922139401,
    3.4190842793973188, 0.51078236975987346, 0.017000000000000001,
    0.017000000000000001, 0.49362497157684782, 0.017000000000000001,
    4.3200314976543615, 0.68801613288300767, 0.017000000000000001,
    2.1934706787952813, 1.6908500257207448, 0.017000000000000001,

    1.6118747189076874, 0.66775325279056807, 0.017000000000000001,
    0.017000000000000001, 1.8256512331126711, 0.017000000000000001,
    0.13939163427286672, 0.017000000000000001, 0.017000000000000001,
    2.8488423924361097, 0.7205318523397779, 0.017000000000000001,
    0.017000000000000001, 0.29685237112207269, 0.017000000000000001,
    0.57011938825044162, 0.017000000000000001, 0.017000000000000001,
    3.6198111695855522, 1.2804826452444358, 0.017000000000000001,
    3.1351122673886467, 0.42468315687193442, 0.017000000000000001,

    3.8205290745936997, 1.4865287497630872, 0.017000000000000001,
    3.368870179608531, 0.57789040082339094, 0.017000000000000001,
    0.87213337650207357, 0.76995280683200507, 0.03219633804313142,
    0.017000000000000001, 0.17669208480581672, 0.017000000000000001,
    1.3136237136865034, 0.2461060048939826, 0.017000000000000001,
    0.64124104998314435, 0.72597392896774893, 0.017000000000000001,
    1.6389244118201229, 0.42252973434337449, 0.017000000000000001,
    0.017000000000000001, 1.0691377816609602, 0.017000000000000001,

    1.817461878505775, 0.20246293122947115, 0.017000000000000001,
    2.4168900025896889, 0.8005894172014083, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.4856467543799963, 0.36481747283615529, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    3.483872979152538, 0.77187099778115698, 0.017000000000000001,
    2.5164933363016191, 0.252644605564595, 0.017000000000000001,
    2.6284908216354239, 0.60553651876473835, 0.017000000000000001,

    0.2377897660710282, 0.164266745978183, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.87184370668299727, 0.45683768037790645, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.98496981698045616, 0.51050090846978724, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.2889433072301695, 0.17345669268899117, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    2.2318755225181288, 0.36186012373901488, 0.11513008596796365,
    0.26085720341774843, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.58060691061610403, 0.19443123775732368, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    // DCT16 SW weights. TODO(user): consider changing.
    0.066752845816433704, 1.0345511079500529, 0.017000000000000001,
    3.901714693527683, 1.3145140817961254, 0.40207908645483781,
    0.017000000000000001, 0.80663555141250309, 0.21525269019000223,
    0.017000000000000001, 1.0279476514055281, 0.017000000000000001,
    0.017000000000000001, 1.1525227394207207, 0.60374291133066682,
    0.017000000000000001, 1.3730757652048902, 0.56472320219124239,
    2.1497811542618708, 1.1533487758898084, 0.092918707350550189,
    2.4864412972401952, 1.0353514236286745, 0.017000000000000001,

    0.37986881611412415, 1.4681240653973313, 0.66141268201743253,
    1.5706203225703981, 0.017000000000000001, 0.017000000000000001,
    1.5039885236472303, 0.46733638399176769, 0.017000000000000001,
    3.3100488952356475, 0.5267770540530764, 0.017000000000000001,
    0.20068779279126658, 1.3775097366568523, 0.017000000000000001,
    0.017000000000000001, 0.71294781138345886, 0.017000000000000001,
    1.0564769884972889, 0.89057516389856217, 0.017000000000000001,
    2.6368941523535065, 0.60362567977552284, 0.017000000000000001,

    1.0027959598479983, 0.42852173943441874, 0.12476587061527462,
    7.5186171455640283, 1.2131566926501274, 0.017000000000000001,
    5.5197242631414793, 0.69835015151836244, 0.60225548742560808,
    0.017000000000000001, 0.017000000000000001, 0.28518608779309074,
    1.0142694810095958, 0.30058954676745614, 0.017000000000000001,
    0.017000000000000001, 0.14985807023702508, 0.017000000000000001,
    3.5434455213096641, 0.38532586763408522, 0.017000000000000001,
    2.750776576004899, 0.73055775775611265, 0.58191115025132545,

    0.017000000000000001, 0.45956837712114507, 0.017000000000000001,
    0.017000000000000001, 0.90153070400546831, 0.017000000000000001,
    1.1235656349061736, 0.15879588940877215, 0.017000000000000001,
    2.7105133342374352, 0.40849023979801952, 0.017000000000000001,
    0.048239988426930669, 0.17147590266762613, 0.017000000000000001,
    0.017000000000000001, 0.073053593121163829, 0.017000000000000001,
    3.0564376307093979, 0.66485842900093195, 0.017000000000000001,
    2.1785413963035687, 0.24445585989661361, 0.017000000000000001,

    1.4096833624023031, 0.68739996131065917, 0.27221669719893965,
    4.8863042022554293, 0.33440658221076103, 0.017000000000000001,
    0.017000000000000001, 0.3324230458966615, 0.017000000000000001,
    0.017000000000000001, 0.089697785394983687, 0.017000000000000001,
    0.13941843493918404, 0.017000000000000001, 0.017000000000000001,
    1.3485369543801582, 0.31952207033441915, 0.017000000000000001,
    1.9062324139005589, 0.23180025144630334, 0.017000000000000001,
    0.017000000000000001, 0.57698400368137015, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.7173970567607137, 0.44082724538179441, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.16462195479343122, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.021194780633382093,
    3.8357286734184122, 0.017000000000000001, 0.017000000000000001,
    0.60258830815141806, 0.017000000000000001, 0.017000000000000001,
    2.8172799042998777, 0.25516216001651026, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.048538384433244576,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.2157793971556688, 0.017000000000000001,
    0.49298326084747995, 0.017000000000000001, 0.017000000000000001,
    0.98796704188416096, 0.25992574105795829, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.087780581783619416, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    0.017000000000000001, 0.17319085361123415, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.0232236454596113, 0.092668212001448036, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    // DCT16 SE weights. TODO(user): consider changing.
    0.017000000000000001, 0.5219254950771216, 0.017000000000000001,
    0.94669541622162168, 0.52328815478398094, 0.017000000000000001,
    0.74949666680947447, 0.48139026453257172, 0.017000000000000001,
    0.89323048588078002, 0.58586738071878719, 0.017000000000000001,
    0.86767145031656556, 0.89767131665561928, 0.017000000000000001,
    0.77427323631628142, 0.65613853073895412, 0.23822170742663518,
    1.6592124729089464, 0.5701775681084027, 0.017000000000000001,
    1.9118659425771447, 0.85352058285172028, 0.017000000000000001,

    0.96197076868772746, 0.017000000000000001, 0.017000000000000001,
    0.38352376265026222, 0.32419763125272894, 0.20812059150243581,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    4.5603853539071624, 0.017000000000000001, 0.17184674955867357,
    4.7116038479900242, 0.61200840429843439, 0.017000000000000001,
    0.017000000000000001, 0.65430724246117056, 0.48536372231218694,
    0.76429980379446838, 0.3955520071792708, 0.017000000000000001,
    3.0164488416800466, 0.24994676447849823, 0.017000000000000001,

    0.017000000000000001, 0.28377750498277549, 0.017000000000000001,
    5.9386420568876392, 0.58126073503114495, 0.017000000000000001,
    5.4009571735313466, 0.43741532977465186, 0.017000000000000001,
    0.017000000000000001, 0.18297492114952205, 0.16788996690447025,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    2.2607377115107488, 0.017000000000000001, 0.017000000000000001,
    1.2933752542510286, 0.20121832787424568, 0.017000000000000001,

    0.43728025039162111, 0.22964080696320016, 0.017000000000000001,
    0.017000000000000001, 0.43590303463929908, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.7905682031220143, 0.20430624588296509, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    1.2439386309864378, 0.26515258147988829, 0.017000000000000001,
    0.017000000000000001, 0.074769048662102877, 0.017000000000000001,

    1.6702107649870146, 0.14171111796828545, 0.017000000000000001,
    1.2118898920829653, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.043589764824690458, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.1025277183220995, 0.017026465572988925, 0.017000000000000001,
    0.3808001692935723, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.079529921839159204,
    0.25256721076392941, 0.15737309263743671, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.89552366337585942, 0.017000000000000001, 0.017000000000000001,
    0.80443162638930454, 0.017000000000000001, 0.017000000000000001,
    2.1641573195888313, 0.089639696408933822, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.64172742708257813, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.13740178570998407, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,
    0.017000000000000001, 0.017000000000000001, 0.017000000000000001,

    // HQ mode
    // Default weights.
    5.97098671763256839, 1.69761990929546780, 0.53853771332792444,
    3.14253990320328125, 0.78664853390117273, 0.17190174775266073,
    3.21440032329272363, 0.79324113975890986, 0.19073348746478294,
    2.31877876078626644, 1.20331026659435092, 0.18068627495819625,
    2.66138348593645846, 1.27976364845854129, 0.14314257421962365,
    2.05669558255116414, 0.67193542643511317, 0.12976541962082244,
    1.89568467702556931, 0.87684508464905198, 0.13840382703261955,
    1.87183877378106178, 0.87332866827360733, 0.13886642497406188,

    1.81376345075241852, 0.90546493291290131, 0.12640806528419762,
    1.38659706271567829, 0.67357513728317564, 0.10046114149393238,
    1.43970070343494916, 0.64960619501539618, 0.10434852182815810,
    1.64121019910504962, 0.67261342673313418, 0.12842635952387660,
    1.46477538313861277, 0.70021253533295424, 0.10903159857162095,
    1.52923458157991998, 0.69961592005489026, 0.09710617072173894,
    1.40023384922801197, 0.68455392518694513, 0.07908914182002977,
    1.33839402167055588, 0.69211618315286805, 0.09308446231558251,

    1.43643407833087378, 0.69628390114558059, 0.08386075776976390,
    1.42012129383485530, 0.65847070005190744, 0.09890816230765243,
    1.68161355944399049, 0.71866143043615716, 0.09940258437481214,
    1.56772586225783828, 0.67160483088794198, 0.09466185289417853,
    1.36510921600277535, 0.62401571586763904, 0.08236434651134468,
    1.03208101627848747, 0.59120245407886063, 0.05912383931246348,
    1.69702527326663510, 0.68535225222980134, 0.09623784903161817,
    1.53252814802078419, 0.72569260047525008, 0.08106185965616462,

    1.40794482088634898, 0.68347344254745312, 0.09180649324754615,
    0.98409717572352373, 0.66630217832243899, 0.08752033959765924,
    1.41539698889807042, 0.51216510866872778, 0.06712898051010259,
    0.95856947616046384, 0.50258164653939053, 0.05876841963372925,
    0.82585586314858783, 0.60553389435339600, 0.05851610562550572,
    1.32551190883622838, 0.52116816325598003, 0.05776704204017307,
    1.42525227948613864, 0.66451111078322889, 0.09029381536978218,
    1.61480964386399450, 0.58319461600661016, 0.08374152456688765,

    1.36272444106781343, 0.56725685656994129, 0.07447525932711950,
    1.23016114633190843, 0.54560308162655557, 0.06244568047577013,
    1.02531080328291346, 0.51073378680450165, 0.05900332401163505,
    0.79645147162795993, 0.48279035076704235, 0.05942394100369194,
    1.10224441792333505, 0.51399854683593382, 0.06488521108420610,
    1.32841168654714181, 0.55615524649126835, 0.09305414673745493,
    1.58130787393576955, 0.52228127315219441, 0.09462056731598355,
    1.32305080787503493, 0.56539808782479895, 0.08967000072418904,

    1.60940316666871319, 0.60902893903479105, 0.08559545911151349,
    1.15852808153812559, 0.57532339125302434, 0.07594769254966900,
    1.41422670295622654, 0.51208334668238098, 0.08262610724104018,
    1.50123574147011585, 0.61420516049012464, 0.08996506605454008,
    1.43030813640267751, 0.52583680560641410, 0.07164827618952087,
    1.66786924477306031, 0.56912874262481383, 0.06055826950374100,
    1.01687835220554090, 0.53050807292462376, 0.06116745665900101,
    1.53314369451989063, 0.58806280311474168, 0.10622593889251969,

    1.13915364970228650, 0.51607666905695815, 0.09892489416863132,
    1.20062442282843995, 0.62042257791036048, 0.07859956608053299,
    1.57803627072360175, 0.56412252798799212, 0.08054184901244756,
    1.45092323858166239, 0.52681964760491928, 0.07837902068062400,
    1.54334806766566768, 0.52727572293349534, 0.08728601353049063,
    1.39711767258527320, 0.57393681796751261, 0.07930505691716441,
    0.78158104550004404, 0.60390867209622334, 0.07462500390508715,
    1.81436012692921311, 0.54071907903714811, 0.07981141132875894,

    0.78511966383388032, 0.55016303699852442, 0.07926565080862039,
    1.15182975200692361, 0.56361259875118574, 0.09215829949648185,
    0.92065100803555544, 0.56635179840667760, 0.10282781177064568,
    1.22537108443054898, 0.54603239891514965, 0.08249748895287572,
    1.57458694038461045, 0.53538377686685823, 0.07811475203273252,
    1.30320516365488825, 0.46393811087230996, 0.09657913185935441,
    0.94422674464538836, 0.46159976390783986, 0.09834404184403754,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,

    // ID weights. TODO(user): consider changing.
    5.97098671763256839, 1.69761990929546780, 0.53853771332792444,
    3.14253990320328125, 0.78664853390117273, 0.17190174775266073,
    3.21440032329272363, 0.79324113975890986, 0.19073348746478294,
    2.31877876078626644, 1.20331026659435092, 0.18068627495819625,
    2.66138348593645846, 1.27976364845854129, 0.14314257421962365,
    2.05669558255116414, 0.67193542643511317, 0.12976541962082244,
    1.89568467702556931, 0.87684508464905198, 0.13840382703261955,
    1.87183877378106178, 0.87332866827360733, 0.13886642497406188,

    1.81376345075241852, 0.90546493291290131, 0.12640806528419762,
    1.38659706271567829, 0.67357513728317564, 0.10046114149393238,
    1.43970070343494916, 0.64960619501539618, 0.10434852182815810,
    1.64121019910504962, 0.67261342673313418, 0.12842635952387660,
    1.46477538313861277, 0.70021253533295424, 0.10903159857162095,
    1.52923458157991998, 0.69961592005489026, 0.09710617072173894,
    1.40023384922801197, 0.68455392518694513, 0.07908914182002977,
    1.33839402167055588, 0.69211618315286805, 0.09308446231558251,

    1.43643407833087378, 0.69628390114558059, 0.08386075776976390,
    1.42012129383485530, 0.65847070005190744, 0.09890816230765243,
    1.68161355944399049, 0.71866143043615716, 0.09940258437481214,
    1.56772586225783828, 0.67160483088794198, 0.09466185289417853,
    1.36510921600277535, 0.62401571586763904, 0.08236434651134468,
    1.03208101627848747, 0.59120245407886063, 0.05912383931246348,
    1.69702527326663510, 0.68535225222980134, 0.09623784903161817,
    1.53252814802078419, 0.72569260047525008, 0.08106185965616462,

    1.40794482088634898, 0.68347344254745312, 0.09180649324754615,
    0.98409717572352373, 0.66630217832243899, 0.08752033959765924,
    1.41539698889807042, 0.51216510866872778, 0.06712898051010259,
    0.95856947616046384, 0.50258164653939053, 0.05876841963372925,
    0.82585586314858783, 0.60553389435339600, 0.05851610562550572,
    1.32551190883622838, 0.52116816325598003, 0.05776704204017307,
    1.42525227948613864, 0.66451111078322889, 0.09029381536978218,
    1.61480964386399450, 0.58319461600661016, 0.08374152456688765,

    1.36272444106781343, 0.56725685656994129, 0.07447525932711950,
    1.23016114633190843, 0.54560308162655557, 0.06244568047577013,
    1.02531080328291346, 0.51073378680450165, 0.05900332401163505,
    0.79645147162795993, 0.48279035076704235, 0.05942394100369194,
    1.10224441792333505, 0.51399854683593382, 0.06488521108420610,
    1.32841168654714181, 0.55615524649126835, 0.09305414673745493,
    1.58130787393576955, 0.52228127315219441, 0.09462056731598355,
    1.32305080787503493, 0.56539808782479895, 0.08967000072418904,

    1.60940316666871319, 0.60902893903479105, 0.08559545911151349,
    1.15852808153812559, 0.57532339125302434, 0.07594769254966900,
    1.41422670295622654, 0.51208334668238098, 0.08262610724104018,
    1.50123574147011585, 0.61420516049012464, 0.08996506605454008,
    1.43030813640267751, 0.52583680560641410, 0.07164827618952087,
    1.66786924477306031, 0.56912874262481383, 0.06055826950374100,
    1.01687835220554090, 0.53050807292462376, 0.06116745665900101,
    1.53314369451989063, 0.58806280311474168, 0.10622593889251969,

    1.13915364970228650, 0.51607666905695815, 0.09892489416863132,
    1.20062442282843995, 0.62042257791036048, 0.07859956608053299,
    1.57803627072360175, 0.56412252798799212, 0.08054184901244756,
    1.45092323858166239, 0.52681964760491928, 0.07837902068062400,
    1.54334806766566768, 0.52727572293349534, 0.08728601353049063,
    1.39711767258527320, 0.57393681796751261, 0.07930505691716441,
    0.78158104550004404, 0.60390867209622334, 0.07462500390508715,
    1.81436012692921311, 0.54071907903714811, 0.07981141132875894,

    0.78511966383388032, 0.55016303699852442, 0.07926565080862039,
    1.15182975200692361, 0.56361259875118574, 0.09215829949648185,
    0.92065100803555544, 0.56635179840667760, 0.10282781177064568,
    1.22537108443054898, 0.54603239891514965, 0.08249748895287572,
    1.57458694038461045, 0.53538377686685823, 0.07811475203273252,
    1.30320516365488825, 0.46393811087230996, 0.09657913185935441,
    0.94422674464538836, 0.46159976390783986, 0.09834404184403754,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,

    // DCT16 NW weights. TODO(user): consider changing.
    5.97098671763256839, 1.69761990929546780, 0.53853771332792444,
    4.55676331041792437, 1.24213422159832021, 0.35521973054029260,
    3.14253990320328125, 0.78664853390117273, 0.17190174775266073,
    3.17847011324800244, 0.78994483683004124, 0.18131761760872184,
    3.21440032329272363, 0.79324113975890986, 0.19073348746478294,
    2.76658954203949481, 0.99827570317663039, 0.18570988121148960,
    2.31877876078626644, 1.20331026659435092, 0.18068627495819625,
    2.49008112336136245, 1.24153695752644611, 0.16191442458890995,

    3.89237508419249334, 1.30154242110418461, 0.33247288930606100,
    3.67879189017412322, 1.18559752328932166, 0.31949942741092840,
    2.26456848295947966, 0.73011183559217419, 0.13618144462329657,
    2.29112030331911498, 0.71812736445828440, 0.13812513479040942,
    2.32705051336383661, 0.72142366738715302, 0.14754100464647052,
    2.42780526119888673, 0.73292728324602208, 0.15957992349432976,
    1.97999447994565791, 0.93796184666374249, 0.15455631724103641,
    1.89177707196243960, 0.95176140096365258, 0.14485893676490860,

    1.81376345075241852, 0.90546493291290131, 0.12640806528419762,
    1.60018025673404840, 0.78952003509803848, 0.11343460338906500,
    1.38659706271567829, 0.67357513728317564, 0.10046114149393238,
    1.41314888307531383, 0.66159066614928586, 0.10240483166104525,
    1.43970070343494916, 0.64960619501539618, 0.10434852182815810,
    1.54045545126999928, 0.66110981087426524, 0.11638744067601735,
    1.64121019910504962, 0.67261342673313418, 0.12842635952387660,
    1.55299279112183131, 0.68641298103304416, 0.11872897904774878,

    1.62509876454164615, 0.80087441702924100, 0.10513441152698076,
    1.61694237229363691, 0.78196781648240443, 0.11265811379592502,
    1.40335917827526679, 0.66602291866754149, 0.09968465190079240,
    1.53410531107983439, 0.69611828385966645, 0.09993186293437226,
    1.56065713143946994, 0.68413381272577667, 0.10187555310148512,
    1.50371328284639372, 0.66060551295166903, 0.09950518736116831,
    1.60446803068144384, 0.67210912881053808, 0.11154410620902756,
    1.50315970755391248, 0.64831457130038661, 0.10539535301761063,

    1.43643407833087378, 0.69628390114558059, 0.08386075776976390,
    1.42827768608286454, 0.67737730059874401, 0.09138446003870816,
    1.42012129383485530, 0.65847070005190744, 0.09890816230765243,
    1.55086742663942290, 0.68856606524403230, 0.09915537334123228,
    1.68161355944399049, 0.71866143043615716, 0.09940258437481214,
    1.62466971085091449, 0.69513313066204963, 0.09703221863449533,
    1.56772586225783828, 0.67160483088794198, 0.09466185289417853,
    1.46641753913030692, 0.64781027337779051, 0.08851309970276161,

    1.42218944960861138, 0.68987867184651686, 0.08783362550865503,
    1.21026562702719875, 0.68129303973400979, 0.08569054868371156,
    1.20210923477918952, 0.66238643918717321, 0.09321425095265584,
    1.41775914136646275, 0.58531790436031761, 0.08301857140887750,
    1.54850527417103034, 0.61541326955244247, 0.08326578244245736,
    1.32009151780222722, 0.61062153848777379, 0.07908550200427070,
    1.26314766920915100, 0.58709323871366625, 0.07671513626395389,
    1.19679086270321311, 0.63856936262066899, 0.07658897925984212,

    1.40794482088634898, 0.68347344254745312, 0.09180649324754615,
    1.19602099830493636, 0.67488781043494606, 0.08966341642260270,
    0.98409717572352373, 0.66630217832243899, 0.08752033959765924,
    1.19974708231079719, 0.58923364349558338, 0.07732466005388092,
    1.41539698889807042, 0.51216510866872778, 0.06712898051010259,
    1.18698323252926707, 0.50737337760405921, 0.06294870007191591,
    0.95856947616046384, 0.50258164653939053, 0.05876841963372925,
    0.89221266965452584, 0.55405777044639326, 0.05864226262961748,

    1.38533463097708109, 0.62536514955869715, 0.08314087628733283,
    1.31905298360912870, 0.61453826208700435, 0.07712608686165814,
    1.10712916102771608, 0.60595262997449728, 0.07498301003671469,
    1.00470398950321860, 0.58851798256347032, 0.07326183180464715,
    1.22035389609049183, 0.51144944773661472, 0.06306615226086881,
    1.10592423026301523, 0.49747772971788506, 0.06327646075689726,
    0.87751047389421188, 0.49268599865321644, 0.05909618031871060,
    1.03040694704189950, 0.50829009668766223, 0.06182681535896768,

    // DCT16 NE weights. TODO(user): consider changing.
    2.66138348593645846, 1.27976364845854129, 0.14314257421962365,
    2.35903953424381108, 0.97584953744682723, 0.13645399692022303,
    2.05669558255116414, 0.67193542643511317, 0.12976541962082244,
    1.97619012978836661, 0.77439025554208252, 0.13408462332672100,
    1.89568467702556931, 0.87684508464905198, 0.13840382703261955,
    1.88376172540331543, 0.87508687646132965, 0.13863512600334071,
    1.87183877378106178, 0.87332866827360733, 0.13886642497406188,
    1.87183877378106178, 0.87332866827360733, 0.13886642497406188,

    2.06307943453753584, 0.98998809189574777, 0.12608708639562230,
    2.09530903375818944, 0.98968978425671583, 0.12012437247068129,
    1.79296508206554206, 0.68577567324500177, 0.11343579517128069,
    1.72846471588958805, 0.67824467581102921, 0.10442728072042610,
    1.64795926312679075, 0.78069950491799855, 0.10874648442632466,
    1.61703934934806259, 0.78448063390096001, 0.11574414467410103,
    1.60511639772580894, 0.78272242571323769, 0.11597544364482219,
    1.60511639772580894, 0.78272242571323769, 0.11597544364482219,

    1.46477538313861277, 0.70021253533295424, 0.10903159857162095,
    1.49700498235926638, 0.69991422769392231, 0.10306888464667995,
    1.52923458157991998, 0.69961592005489026, 0.09710617072173894,
    1.46473421540396598, 0.69208492262091770, 0.08809765627088435,
    1.40023384922801197, 0.68455392518694513, 0.07908914182002977,
    1.36931393544928381, 0.68833505416990659, 0.08608680206780614,
    1.33839402167055588, 0.69211618315286805, 0.09308446231558251,
    1.33839402167055588, 0.69211618315286805, 0.09308446231558251,

    1.41494229957069395, 0.66211412560029670, 0.09569797254148282,
    1.24842819970855023, 0.64570749470590738, 0.08407771894204222,
    1.28065779892920384, 0.64540918706687544, 0.07811500501710121,
    1.61312992742327754, 0.69248408614234580, 0.09667200987667855,
    1.54862956124732354, 0.68495308870837324, 0.08766349542582397,
    1.46638099862439808, 0.70512326283109761, 0.08007550073809719,
    1.43546108484567014, 0.70890439181405906, 0.08707316098587356,
    1.43546108484567014, 0.70890439181405906, 0.08707316098587356,

    1.36510921600277535, 0.62401571586763904, 0.08236434651134468,
    1.19859511614063141, 0.60760908497324984, 0.07074409291190409,
    1.03208101627848747, 0.59120245407886063, 0.05912383931246348,
    1.36455314477256140, 0.63827735315433098, 0.07768084417204082,
    1.69702527326663510, 0.68535225222980134, 0.09623784903161817,
    1.61477671064370965, 0.70552242635252571, 0.08864985434389139,
    1.53252814802078419, 0.72569260047525008, 0.08106185965616462,
    1.53252814802078419, 0.72569260047525008, 0.08106185965616462,

    1.09548253957568154, 0.61477480511051752, 0.07044022606842520,
    1.34531056241950187, 0.57259193956180954, 0.07006569427575887,
    1.17879646255735793, 0.55618530866742033, 0.05844544067631828,
    1.22866664788231317, 0.62785678243104481, 0.07470882734112283,
    1.56113877637638687, 0.67493168150651517, 0.09326583220070017,
    1.65591745856531469, 0.63427343411820569, 0.08998968679925290,
    1.57366889594238923, 0.65444360824093017, 0.08240169211152613,
    1.57366889594238923, 0.65444360824093017, 0.08240169211152613,

    0.82585586314858783, 0.60553389435339600, 0.05851610562550572,
    1.07568388599240805, 0.56335102880468801, 0.05814157383283940,
    1.32551190883622838, 0.52116816325598003, 0.05776704204017307,
    1.37538209416118340, 0.59283963701960452, 0.07403042870497763,
    1.42525227948613864, 0.66451111078322889, 0.09029381536978218,
    1.52003096167506646, 0.62385286339491952, 0.08701766996833490,
    1.61480964386399450, 0.58319461600661016, 0.08374152456688765,
    1.61480964386399450, 0.58319461600661016, 0.08374152456688765,

    0.96405014053596139, 0.55976622059466496, 0.06170065835485591,
    1.07713377484786488, 0.58084457042233217, 0.07578512618148033,
    1.32696179769168499, 0.53866170487362419, 0.07541059438881401,
    1.45340989138599896, 0.52172471820408717, 0.07619380467807831,
    1.50328007671095421, 0.59339619196771165, 0.09245719134288286,
    1.37415154368058667, 0.61495459930401397, 0.08998190804698561,
    1.46893022586951472, 0.57429635191570449, 0.08670576264553834,
    1.46893022586951472, 0.57429635191570449, 0.08670576264553834,

    // DCT16 SW weights. TODO(user): consider changing.
    1.36272444106781343, 0.56725685656994129, 0.07447525932711950,
    1.29644279369986082, 0.55642996909824838, 0.06846046990144482,
    1.23016114633190843, 0.54560308162655557, 0.06244568047577013,
    1.12773597480741095, 0.52816843421552861, 0.06072450224370259,
    1.02531080328291346, 0.51073378680450165, 0.05900332401163505,
    0.91088113745543664, 0.49676206878577200, 0.05921363250766350,
    0.79645147162795993, 0.48279035076704235, 0.05942394100369194,
    0.94934794477564743, 0.49839444880148809, 0.06215457604394901,

    1.48606380386826320, 0.58814289780236617, 0.08003535921931650,
    1.26062626130296951, 0.57129012391148282, 0.07521147593839425,
    1.19434461393501712, 0.56046323643978990, 0.06919668651271957,
    1.32219392464406749, 0.52884321415446833, 0.07253589385840516,
    1.21976875311957000, 0.51140856674344137, 0.07081471562633762,
    1.26327327237651454, 0.56246947364731315, 0.07448419503308756,
    1.14884360654903794, 0.54849775562858349, 0.07469450352911601,
    1.11337980401531866, 0.50431357818672828, 0.06553610859660640,

    1.60940316666871319, 0.60902893903479105, 0.08559545911151349,
    1.38396562410341950, 0.59217616514390770, 0.08077157583059125,
    1.15852808153812559, 0.57532339125302434, 0.07594769254966900,
    1.28637739224717595, 0.54370336896770266, 0.07928689989535459,
    1.41422670295622654, 0.51208334668238098, 0.08262610724104018,
    1.45773122221317131, 0.56314425358625275, 0.08629558664779013,
    1.50123574147011585, 0.61420516049012464, 0.08996506605454008,
    1.46577193893639679, 0.57002098304826943, 0.08080667112203047,

    1.37427840818549996, 0.56255280404587460, 0.09226017664007241,
    1.40501379474857657, 0.61472575847257582, 0.08209751259602324,
    1.17957625218328266, 0.59787298458169236, 0.07727362931510100,
    1.36828217613086367, 0.56972295962050823, 0.07824477078105828,
    1.49613148683991426, 0.53810293733518655, 0.08158397812674387,
    1.43257497076894458, 0.51945149714365013, 0.08050256396083208,
    1.47607949002588912, 0.57051240404752201, 0.08417204336758204,
    1.52229190456789176, 0.57074044171181004, 0.08862553979251536,

    1.13915364970228650, 0.51607666905695815, 0.09892489416863132,
    1.16988903626536311, 0.56824962348365937, 0.08876223012458215,
    1.20062442282843995, 0.62042257791036048, 0.07859956608053299,
    1.38933034677602096, 0.59227255294917636, 0.07957070754649027,
    1.57803627072360175, 0.56412252798799212, 0.08054184901244756,
    1.51447975465263207, 0.54547108779645570, 0.07946043484653578,
    1.45092323858166239, 0.52681964760491928, 0.07837902068062400,
    1.49713565312366503, 0.52704768526920731, 0.08283251710555731,

    0.96213665676808335, 0.53311985302774123, 0.08909527248862585,
    1.14549170085460505, 0.53984463390407189, 0.09554159683255659,
    1.17622708741768189, 0.59201758833077311, 0.08537893278850742,
    1.06063771543199770, 0.59338718815851910, 0.09071368892558934,
    1.24934363937957871, 0.56523716319733486, 0.09168483039154662,
    1.40170367757707526, 0.55507746345157094, 0.08151966898266164,
    1.33814716150610558, 0.53642602326003441, 0.08043825481674985,
    1.51275508948313631, 0.53110171223588876, 0.07824688635667826,

    0.78511966383388032, 0.55016303699852442, 0.07926565080862039,
    0.96847470792040191, 0.55688781787485508, 0.08571197515255112,
    1.15182975200692361, 0.56361259875118574, 0.09215829949648185,
    1.03624038002123964, 0.56498219857893162, 0.09749305563356377,
    0.92065100803555544, 0.56635179840667760, 0.10282781177064568,
    1.07301104623305221, 0.55619209866091368, 0.09266265036176069,
    1.22537108443054898, 0.54603239891514965, 0.08249748895287572,
    1.39997901240757971, 0.54070808789100400, 0.08030612049280411,

    0.78511966383388032, 0.55016303699852442, 0.07926565080862039,
    0.96847470792040191, 0.55688781787485508, 0.08571197515255112,
    1.15182975200692361, 0.56361259875118574, 0.09215829949648185,
    1.03624038002123964, 0.56498219857893162, 0.09749305563356377,
    0.92065100803555544, 0.56635179840667760, 0.10282781177064568,
    1.07301104623305221, 0.55619209866091368, 0.09266265036176069,
    1.22537108443054898, 0.54603239891514965, 0.08249748895287572,
    1.39997901240757971, 0.54070808789100400, 0.08030612049280411,

    // DCT16 SE weights. TODO(user): consider changing.
    1.10224441792333505, 0.51399854683593382, 0.06488521108420610,
    1.21532805223523832, 0.53507689666360103, 0.07896967891083051,
    1.32841168654714181, 0.55615524649126835, 0.09305414673745493,
    1.45485978024145579, 0.53921825982173144, 0.09383735702671925,
    1.58130787393576955, 0.52228127315219441, 0.09462056731598355,
    1.45217934090540224, 0.54383968048849662, 0.09214528402008629,
    1.32305080787503493, 0.56539808782479895, 0.08967000072418904,
    1.32305080787503493, 0.56539808782479895, 0.08967000072418904,

    1.26627627716300628, 0.51991767622117391, 0.06826674363686348,
    1.38505683134819768, 0.54156364473037377, 0.06272174029397355,
    1.49814046566010095, 0.56264199455804109, 0.07680620812059796,
    1.17264501937634136, 0.54333165970794606, 0.07711080169822797,
    1.29909311307065511, 0.52639467303840903, 0.07789401198749228,
    1.55722578422783009, 0.55517203813346805, 0.10042325310425163,
    1.42809725119746278, 0.57673044546977037, 0.09794796980835437,
    1.42809725119746278, 0.57673044546977037, 0.09794796980835437,

    1.43030813640267751, 0.52583680560641410, 0.07164827618952087,
    1.54908869058786891, 0.54748277411561397, 0.06610327284663094,
    1.66786924477306031, 0.56912874262481383, 0.06055826950374100,
    1.34237379848930072, 0.54981840777471880, 0.06086286308137100,
    1.01687835220554090, 0.53050807292462376, 0.06116745665900101,
    1.27501102336271588, 0.55928543801968278, 0.08369669777576035,
    1.53314369451989063, 0.58806280311474168, 0.10622593889251969,
    1.53314369451989063, 0.58806280311474168, 0.10622593889251969,

    1.48682810203417271, 0.52655626426995472, 0.07946714486000575,
    1.41371290449397535, 0.54988681178696330, 0.07547666655334265,
    1.53249345867916675, 0.57153278029616317, 0.06993166321045270,
    1.22472514513655217, 0.58651870736051859, 0.06759163670441408,
    0.89922969885279247, 0.56720837251042355, 0.06789623028204408,
    1.41561923956737701, 0.53561357598088599, 0.07048943399387997,
    1.67375191072455198, 0.56439094107594490, 0.09301867511063931,
    1.67375191072455198, 0.56439094107594490, 0.09301867511063931,

    1.54334806766566768, 0.52727572293349534, 0.08728601353049063,
    1.47023287012547055, 0.55060627045050392, 0.08329553522382752,
    1.39711767258527320, 0.57393681796751261, 0.07930505691716441,
    1.08934935904265862, 0.58892274503186792, 0.07696503041112579,
    0.78158104550004404, 0.60390867209622334, 0.07462500390508715,
    1.29797058621462869, 0.57231387556668567, 0.07721820761692305,
    1.81436012692921311, 0.54071907903714811, 0.07981141132875894,
    1.81436012692921311, 0.54071907903714811, 0.07981141132875894,

    1.55896750402513895, 0.53132974990017678, 0.08270038278161157,
    1.42327661566027786, 0.49560691690290265, 0.09193257269492253,
    1.35016141812008073, 0.51893746441991129, 0.08794209438825941,
    1.17067220861533072, 0.51776829093767618, 0.08882454938060097,
    0.86290389507271614, 0.53275421800203160, 0.08648452287456235,
    1.11065657124652395, 0.53373601439957641, 0.07531942933061037,
    1.62704611196110860, 0.50214121787003874, 0.07791263304244625,
    1.62704611196110860, 0.50214121787003874, 0.07791263304244625,

    1.57458694038461045, 0.53538377686685823, 0.07811475203273252,
    1.43889605201974935, 0.49966094386958410, 0.08734694194604346,
    1.30320516365488825, 0.46393811087230996, 0.09657913185935441,
    1.12371595415013825, 0.46276893739007491, 0.09746158685169598,
    0.94422674464538836, 0.46159976390783986, 0.09834404184403754,
    1.19197942081919628, 0.46258156030538461, 0.08717894830008556,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,

    1.57458694038461045, 0.53538377686685823, 0.07811475203273252,
    1.43889605201974935, 0.49966094386958410, 0.08734694194604346,
    1.30320516365488825, 0.46393811087230996, 0.09657913185935441,
    1.12371595415013825, 0.46276893739007491, 0.09746158685169598,
    0.94422674464538836, 0.46159976390783986, 0.09834404184403754,
    1.19197942081919628, 0.46258156030538461, 0.08717894830008556,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,
    1.43973209699300408, 0.46356335670292936, 0.07601385475613358,

};
  return &kQuantWeights[0];
}

template <>
const double* GetQuantWeights<16>() {
  // TODO(user): add missing quantization kinds.
  static double kQuantWeights[kNumQuantTables * 3 * 16 * 16] = {
    // Default weights
    6.000000, 1.414214, 0.500000,
    4.000000, 1.154701, 0.333333,
    4.000000, 1.154701, 0.333333,
    3.000000, 1.000000, 0.250000,
    3.000000, 1.000000, 0.250000,
    3.000000, 1.000000, 0.250000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    1.714286, 0.755929, 0.142857,

    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,

    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,

    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,

    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,

    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,

    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,

    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,

    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,

    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,

    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,

    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,

    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,

    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,

    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,

    0.444444, 0.384900, 0.037037,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.400000, 0.365148, 0.033333,
    0.400000, 0.365148, 0.033333,
    0.400000, 0.365148, 0.033333,
    0.387097, 0.359211, 0.032258,
    0.387097, 0.359211, 0.032258,
    0.375000, 0.353553, 0.031250,

    // Weights for HQ mode
    6.000000, 1.414214, 0.500000,
    4.000000, 1.154701, 0.333333,
    4.000000, 1.154701, 0.333333,
    3.000000, 1.000000, 0.250000,
    3.000000, 1.000000, 0.250000,
    3.000000, 1.000000, 0.250000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.400000, 0.894427, 0.200000,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    2.000000, 0.816497, 0.166667,
    1.714286, 0.755929, 0.142857,

    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.714286, 0.755929, 0.142857,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.500000, 0.707107, 0.125000,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,

    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.333333, 0.666667, 0.111111,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.200000, 0.632456, 0.100000,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,

    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.090909, 0.603023, 0.090909,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,

    1.000000, 0.577350, 0.083333,
    1.000000, 0.577350, 0.083333,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.923077, 0.554700, 0.076923,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,

    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.857143, 0.534522, 0.071429,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,

    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.800000, 0.516398, 0.066667,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,

    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.750000, 0.500000, 0.062500,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,

    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.705882, 0.485071, 0.058824,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,

    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.666667, 0.471405, 0.055556,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,

    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.631579, 0.458831, 0.052632,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,

    0.600000, 0.447214, 0.050000,
    0.600000, 0.447214, 0.050000,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.571429, 0.436436, 0.047619,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,

    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.545455, 0.426401, 0.045455,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,

    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.521739, 0.417029, 0.043478,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.500000, 0.408248, 0.041667,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,

    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.480000, 0.400000, 0.040000,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.461538, 0.392232, 0.038462,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,
    0.444444, 0.384900, 0.037037,

    0.444444, 0.384900, 0.037037,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.428571, 0.377964, 0.035714,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.413793, 0.371391, 0.034483,
    0.400000, 0.365148, 0.033333,
    0.400000, 0.365148, 0.033333,
    0.400000, 0.365148, 0.033333,
    0.387097, 0.359211, 0.032258,
    0.387097, 0.359211, 0.032258,
    0.375000, 0.353553, 0.031250,
  };
  return &kQuantWeights[0];
}
// clang-format on

template <int N>
const float* NewDequantMatrices() {
  constexpr int block_size = N * N;
  constexpr int table_size = 3 * block_size;
  const int32_t* natural_coeff_order = NaturalCoeffOrder<N>();
  const float* idct_scales = IDCTScales<N>();
  float* table = static_cast<float*>(CacheAligned::Allocate(
      kNumQuantTables * kNumQuantKinds * table_size * sizeof(float)));
  for (int id = 0; id < kNumQuantTables * kNumQuantKinds; ++id) {
    const double* quant_weights = &GetQuantWeights<N>()[id * table_size];
    for (int idx = 0; idx < 3 * block_size; ++idx) {
      int c = idx % 3;
      int k_zz = idx / 3;
      int k = natural_coeff_order[k_zz];
      float idct_scale = idct_scales[k % N] * idct_scales[k / N] / block_size;
      double weight = quant_weights[idx];
      // TODO(user): this magic value might depend on N.
      if (weight < 0.001) {
        weight = 0.001;
      }
      table[id * table_size + c * block_size + k] = idct_scale / weight;
    }
  }
  return table;
}

// Returns aligned memory.
template <int N>
const float* DequantMatrix(int id, size_t quant_kind) {
  PIK_ASSERT(quant_kind < kNumQuantKinds);
  static const float* const kDequantMatrix = NewDequantMatrices<N>();
  return &kDequantMatrix[(id * kNumQuantKinds + quant_kind) * 3 * N * N];
}
template const float* DequantMatrix<8>(int id, size_t quant_kind);
template const float* DequantMatrix<16>(int id, size_t quant_kind);

Quantizer::Quantizer(size_t block_dim, int template_id, int quant_xsize,
                     int quant_ysize)
    : block_dim_(block_dim),
      quant_xsize_(quant_xsize),
      quant_ysize_(quant_ysize),
      template_id_(template_id % kNumQuantTables),
      global_scale_(kGlobalScaleDenom / kDefaultQuant),
      quant_dc_(kDefaultQuant),
      quant_img_ac_(quant_xsize_, quant_ysize_),
      initialized_(false) {
  RecomputeFromGlobalScale();

  const size_t block_size = block_dim_ * block_dim_;
  quant_matrix_.resize(3 * kNumQuantKinds * block_size);

  FillImage(kDefaultQuant, &quant_img_ac_);

  PIK_ASSERT(template_id < kNumQuantTables);
  if (template_id == kQuantHQ) {
    memcpy(zero_bias_, kZeroBiasHQ, sizeof(kZeroBiasHQ));
  } else {
    memcpy(zero_bias_, kZeroBiasDefault, sizeof(kZeroBiasDefault));
  }
}

const float* Quantizer::DequantMatrix(int c, size_t quant_kind) const {
  // TODO(user): if block_dim_ is 16, not all the necessary coefficients
  // are present in the kQuantWeights table.
  PIK_ASSERT(block_dim_ == 8);
  const float* matrix = (block_dim_ == 8)
                            ? pik::DequantMatrix<8>(template_id_, quant_kind)
                            : pik::DequantMatrix<16>(template_id_, quant_kind);
  return &matrix[c * block_dim_ * block_dim_];
}

void Quantizer::GetQuantField(float* quant_dc, ImageF* qf) {
  const float scale = Scale();
  *quant_dc = scale * quant_dc_;
  *qf = ImageF(quant_xsize_, quant_ysize_);
  for (size_t y = 0; y < quant_ysize_; ++y) {
    for (size_t x = 0; x < quant_xsize_; ++x) {
      qf->Row(y)[x] = scale * quant_img_ac_.Row(y)[x];
    }
  }
}

std::string Quantizer::Encode(PikImageSizeInfo* info) const {
  std::stringstream ss;
  static_assert(kNumQuantTables <= 2, "template_id is supposed to be 1 bit");
  int global_scale_and_template_id = (global_scale_ - 1) | (template_id_ << 15);
  ss << std::string(1, global_scale_and_template_id >> 8);
  ss << std::string(1, global_scale_and_template_id & 0xff);
  ss << std::string(1, quant_dc_ - 1);
  if (info) {
    info->total_size += 3;
  }
  return ss.str();
}

bool Quantizer::Decode(BitReader* br) {
  int global_scale_and_template_id = br->ReadBits(8) << 8;
  global_scale_and_template_id += br->ReadBits(8);
  quant_dc_ = br->ReadBits(8) + 1;
  global_scale_ = (global_scale_and_template_id & 0x7FFF) + 1;
  template_id_ = global_scale_and_template_id >> 15;
  RecomputeFromGlobalScale();
  inv_quant_dc_ = inv_global_scale_ / quant_dc_;
  initialized_ = true;
  return true;
}

void Quantizer::DumpQuantizationMap() const {
  printf("Global scale: %d (%.7f)\nDC quant: %d\n", global_scale_,
         global_scale_ * 1.0 / kGlobalScaleDenom, quant_dc_);
  printf("AC quantization Map:\n");
  for (size_t y = 0; y < quant_img_ac_.ysize(); ++y) {
    for (size_t x = 0; x < quant_img_ac_.xsize(); ++x) {
      printf(" %3d", quant_img_ac_.Row(y)[x]);
    }
    printf("\n");
  }
}

// Works in "DC image", i.e. transforms every pixel.
Image3S QuantizeCoeffsDC(const Image3F& dc, const Quantizer& quantizer) {
  const size_t xsize_blocks = dc.xsize();
  const size_t ysize_blocks = dc.ysize();
  Image3S out(xsize_blocks, ysize_blocks);
  for (int c = 0; c < 3; ++c) {
    for (size_t by = 0; by < ysize_blocks; ++by) {
      const float* PIK_RESTRICT row_in = dc.PlaneRow(c, by);
      int16_t* PIK_RESTRICT row_out = out.PlaneRow(c, by);
      for (size_t bx = 0; bx < xsize_blocks; ++bx) {
        row_out[bx] = quantizer.QuantizeDC(c, row_in[bx]);
      }
    }
  }
  return out;
}

template <int N>
ImageF QuantizeRoundtripExtractHVD(const Quantizer& quantizer, int c,
                                   const ImageF& coeffs,
                                   const ImageB& ac_strategy) {
  PIK_ASSERT(N == quantizer.block_dim());
  constexpr int block_size = N * N;
  const size_t xsize_blocks = coeffs.xsize() / block_size;
  const size_t ysize_blocks = coeffs.ysize();
  ImageF out(4 * xsize_blocks, ysize_blocks);

  for (size_t by = 0; by < ysize_blocks; ++by) {
    const float* PIK_RESTRICT row_in = coeffs.ConstRow(by);
    float* PIK_RESTRICT row_out = out.Row(by);
    const int32_t* row_quant = quantizer.RawQuantField().ConstRow(by);
    for (size_t bx = 0; bx < xsize_blocks; ++bx) {
      const size_t kind = GetQuantKindFromAcStrategy(ac_strategy, bx, by);
      const float* PIK_RESTRICT dequant_matrix =
          quantizer.DequantMatrix(c, kind);
      const int32_t quant_ac = row_quant[bx];
      const float inv_quant_ac = quantizer.inv_quant_ac(quant_ac);
      const float* PIK_RESTRICT block_in = &row_in[bx * block_size];
      float* PIK_RESTRICT block_out = &row_out[bx * 4];
      int16_t qblock[block_size];
      quantizer.QuantizeBlock2x2(quant_ac, kind, c, block_in, qblock);
      block_out[1] = qblock[1] * (dequant_matrix[1] * inv_quant_ac);
      block_out[2] = qblock[N] * (dequant_matrix[N] * inv_quant_ac);
      block_out[3] = qblock[N + 1] * (dequant_matrix[N + 1] * inv_quant_ac);
    }
  }
  return out;
}

ImageF QuantizeRoundtripExtractHVD(const Quantizer& quantizer, int c,
                                   const ImageF& coeffs,
                                   const ImageB& ac_strategy) {
  PIK_ASSERT((quantizer.block_dim() == 8) || (quantizer.block_dim() == 16));
  return (quantizer.block_dim() == 8)
             ? QuantizeRoundtripExtractHVD<8>(quantizer, c, coeffs, ac_strategy)
             : QuantizeRoundtripExtractHVD<16>(quantizer, c, coeffs,
                                               ac_strategy);
}

ImageF QuantizeRoundtripDC(const Quantizer& quantizer, int c,
                           const ImageF& dc) {
  // All coordinates are blocks.
  const int xsize_blocks = dc.xsize();
  const int ysize_blocks = dc.ysize();
  ImageF out(xsize_blocks, ysize_blocks);

  // Always use DCT8 quantization kind for DC
  const float mul =
      quantizer.DequantMatrix(c, kQuantKindDCT8)[0] * quantizer.inv_quant_dc();
  for (size_t by = 0; by < ysize_blocks; ++by) {
    const float* PIK_RESTRICT row_in = dc.ConstRow(by);
    float* PIK_RESTRICT row_out = out.Row(by);
    for (size_t bx = 0; bx < xsize_blocks; ++bx) {
      row_out[bx] = quantizer.QuantizeDC(c, row_in[bx]) * mul;
    }
  }
  return out;
}

Image3F QuantizeRoundtripExtractHVD(const Quantizer& quantizer,
                                    const Image3F& coeffs,
                                    const ImageB& ac_strategy) {
  return Image3F(
      QuantizeRoundtripExtractHVD(quantizer, 0, coeffs.Plane(0), ac_strategy),
      QuantizeRoundtripExtractHVD(quantizer, 1, coeffs.Plane(1), ac_strategy),
      QuantizeRoundtripExtractHVD(quantizer, 2, coeffs.Plane(2), ac_strategy));
}

Image3F QuantizeRoundtripDC(const Quantizer& quantizer, const Image3F& coeffs) {
  return Image3F(QuantizeRoundtripDC(quantizer, 0, coeffs.Plane(0)),
                 QuantizeRoundtripDC(quantizer, 1, coeffs.Plane(1)),
                 QuantizeRoundtripDC(quantizer, 2, coeffs.Plane(2)));
}

size_t GetQuantKindFromAcStrategy(const ImageB& ac_strategy, size_t xb,
                                  size_t yb) {
  uint8_t strategy = ac_strategy.ConstRow(yb)[xb];
  if (AcStrategyType::IsDct(strategy)) return kQuantKindDCT8;
  if (AcStrategyType::IsIdentity(strategy)) return kQuantKindID;
  if (AcStrategyType::IsDct16x16(strategy)) return kQuantKindDCT16NW;
  if (AcStrategyType::IsNone(strategy)) {
    if (xb != 0 && AcStrategyType::IsDct16x16(ac_strategy.ConstRow(yb)[xb - 1]))
      return kQuantKindDCT16NE;
    if (yb != 0 && AcStrategyType::IsDct16x16(ac_strategy.ConstRow(yb - 1)[xb]))
      return kQuantKindDCT16SW;
    if (xb != 0 && yb != 0 &&
        AcStrategyType::IsDct16x16(ac_strategy.ConstRow(yb - 1)[xb - 1]))
      return kQuantKindDCT16SE;
    // A None block must be because of a DCT16 block in its neighbourhood.
    PIK_ASSERT(false);
  }
  // Unknown AC strategy.
  PIK_ASSERT(false);
  return -1;
}

}  // namespace pik
